name: CI/CD Pipeline (Kind Test)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2️⃣ Install Docker (if not pre-installed)
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # 3️⃣ Install Kind
    - name: Install Kind
      run: |
        curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.22.1/kind-linux-amd64
        chmod +x ./kind
        sudo mv ./kind /usr/local/bin/kind
        kind version

    # 4️⃣ Create Kind cluster
    - name: Create Kind cluster
      run: |
        kind create cluster --name test-cluster
        kubectl cluster-info

    # 5️⃣ Build Docker image
    - name: Build Docker image
      run: docker build -t flask-hello-world:latest .

    # 6️⃣ Load image into Kind cluster
    - name: Load image into Kind
      run: kind load docker-image flask-hello-world:latest --name test-cluster

    # 7️⃣ Deploy to Kubernetes
    - name: Deploy app
      run: |
        kubectl apply -f deployment.yaml
        kubectl apply -f service.yaml

    # 8️⃣ Show deployed pods
    - name: Show pods
      run: kubectl get pods

    # 9️⃣ Test Flask app endpoint
    - name: Test Flask app
      run: |
        # Port-forward the service in background
        kubectl port-forward svc/flask-hello-world 5000:5000 &
        PORT_FORWARD_PID=$!

        # Wait a few seconds for the port-forward to start
        sleep 5

        # Test the endpoint
        curl -f http://localhost:5000 || exit 1

        # Kill the port-forward process
        kill $PORT_FORWARD_PID
